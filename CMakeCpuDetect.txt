include(CheckCXXSourceRuns)

# AVX
set(CMAKE_REQUIRED_FLAGS "-mavx")
set(AVX_TEST_SOURCE "
#include <immintrin.h>
int main() {
    __m256 a = _mm256_set_ps(0, 1, 2, 3, 4, 5, 6, 7);
    __m256 b = _mm256_set_ps(7, 6, 5, 4, 3, 2, 1, 0);
    __m256 c = _mm256_add_ps(a, b);
    return 0;
}")
check_cxx_source_runs("${AVX_TEST_SOURCE}" AVX_SUPPORTED)

# AVX2
set(CMAKE_REQUIRED_FLAGS "-mavx2")
set(AVX2_TEST_SOURCE "
#include <immintrin.h>
int main() {
    __m256i a = _mm256_set_epi32(0, 1, 2, 3, 4, 5, 6, 7);
    __m256i b = _mm256_set_epi32(7, 6, 5, 4, 3, 2, 1, 0);
    __m256i c = _mm256_add_epi32(a, b);
    return 0;
}")
check_cxx_source_runs("${AVX2_TEST_SOURCE}" AVX2_SUPPORTED)

set(AVX512_TEST_SOURCE "
#include <immintrin.h>
int main() {
    __m512d a = _mm512_set_pd(0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0);
    __m512d b = _mm512_set_pd(7.0, 6.0, 5.0, 4.0, 3.0, 2.0, 1.0, 0.0);
    __m512d c = _mm512_add_pd(a, b);
    return 0;
}")

check_cxx_source_runs("${AVX512_TEST_SOURCE}" AVX512_SUPPORTED)

# SSE2
set(CMAKE_REQUIRED_FLAGS "-msse2")
set(SSE2_TEST_SOURCE "
#include <emmintrin.h>
int main() {
    __m128i a = _mm_set_epi32(0, 1, 2, 3);
    __m128i b = _mm_set_epi32(3, 2, 1, 0);
    __m128i c = _mm_add_epi32(a, b);
    return 0;
}")
check_cxx_source_runs("${SSE2_TEST_SOURCE}" SSE2_SUPPORTED)
